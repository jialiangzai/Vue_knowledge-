# 我的

### 01-个人中心-首页-基础布局

> 使用准备好的静态模版布局我的，了解结构样式	

* 了解Layout布局组件

`src/views/profile/index.vue`

结构：

```html
<div class="user-profile">
      <div class="info">
        <van-image round src="https://img.yzcdn.cn/vant/cat.jpeg" />
        <h3 class="name">
          用户名
          <br />
          <van-tag size="mini">申请认证</van-tag>
        </h3>
      </div>
      <van-row>
        <van-col span="8">
          <p>0</p>
          <p>动态</p>
        </van-col>
        <van-col span="8">
          <p>0</p>
          <p>关注</p>
        </van-col>
        <van-col span="8">
          <p>0</p>
          <p>粉丝</p>
        </van-col>
      </van-row>
    </div>
    <van-row class="user-links">
      <van-col span="8">
        <van-icon name="newspaper-o" color="#7af"/>我的作品
      </van-col>
      <van-col span="8">
        <van-icon name="star-o" color="#f00"/>我的收藏
      </van-col>
      <van-col span="8">
        <van-icon name="tosend" color="#fa0"/>阅读历史
      </van-col>
    </van-row>

    <van-cell-group class="user-group">
      <van-cell icon="edit" title="编辑资料" to="/user/profile" is-link />
      <van-cell icon="chat-o" title="小智同学" to="/user/chat" is-link />
      <van-cell icon="setting-o" title="系统设置" is-link />
      <van-cell icon="warning-o" title="退出登录" is-link />
    </van-cell-group>
```

样式：

```less
.user {
  &-profile {
    width: 100%;
    height: 150px;
    display: block;
    background: #3296fa;
    color: #fff;
    .info {
      display: flex;
      padding: 20px;
      align-items: center;
      .van-image {
        width: 64px;
        height: 64px;
      }
      .name {
        font-size: 16px;
        font-weight: normal;
        margin-left: 10px;
      }
      .van-tag {
        background: #fff;
        color: #3296fa;
      }
    }
    p {
      margin: 0;
      text-align: center;
    }
  }
  &-group {
    margin-bottom: 15px;
    text-align: left;
  }
  &-links {
    padding: 15px 0;
    font-size: 12px;
    text-align: center;
    background-color: #fff;
    .van-icon {
      display: block;
      font-size: 24px;
      padding-bottom: 5px;
    }
  }
}
```



### 02-个人中心-首页-渲染

> 获取当前登录人的信息并展示

* 定义API `src/api/user.js`=>获取用户(登录人)自己信息

```js
/**
 * 获取用户个人信息
 */
export function getUserInfo() {
  return request.get('user')
}
```

* 获取个人信息

```js
import { getUserInfo } from '@/api/user'
export default {
  name: 'user-index',
  data () {
    return {
      user: {}
    }
  },
  created () {
    this.getUserInfo()
  },
  methods: {
    async getUserInfo () {
      const { status, data } = await getUserInfo()
      if (status === 200) {
        this.user = data
      }
    }
  }
}
```

* 渲染组件：

```html
    <div class="user-profile">
      <div class="info">
        <van-image round :src="user.photo" />
        <h3 class="name">
          {{user.name}}
          <br />
          <van-tag size="mini">申请认证</van-tag>
        </h3>
      </div>
      <van-row>
        <van-col span="6">
          <p>{{user.art_count}}</p>
          <p>动态</p>
        </van-col>
        <van-col span="6">
          <p>{{user.follow_count}}</p>
          <p>关注</p>
        </van-col>
        <van-col span="6">
          <p>{{user.fans_count}}</p>
          <p>粉丝</p>
        </van-col>
        <van-col span="6">
          <p>{{user.like_count}}</p>
          <p>被赞</p>
        </van-col>
      </van-row>
    </div>
```



### 03-个人中心-首页-退出登录

> 退出登录

* 绑定事件

```html
 <van-cell @click="logout()" icon="warning-o" title="退出登录" is-link />
```

```js
import { mapMutations } from 'vuex'
```
* 导入修改store数据方法，清除本地登录
```js
    ...mapMutations(['delUser']),
    logout () {
      // 弹出确认框 dialog 组件 和toast组件使用相似
      this.$dialog.confirm({
        title: '温馨提示',
        message: '亲，您确认退出黑马头条吗？'
      }).then(() => {
        // 退出：删除vuex和本地的用户信息
        this.delUser()
        this.$router.push('/login')
      }).catch(() => {
        // click cancel
      })
    }
```



### 04-个人中心-编辑资料-基础布局

> 编辑个人资料页面，使用van-cell做基础布局

* 根据模板展示效果，了解交互和用法
* 了解van-datetime-picker组件用法

结构：

`src/views/user/index.vue`

```html
<div class="container">
    <van-nav-bar left-arrow @click-left="$router.back()" title="编辑资料" right-text="保存" />          
    <!-- 用户资料 -->  
    <van-cell-group>
      <van-cell is-link title="头像" @click="showPhoto=true" center>
        <van-image
          slot="default"
          width="1.5rem"
          height="1.5rem"
          fit="cover"
          round
          :src="photo"
        />
      </van-cell>
      <van-cell is-link title="名称" @click="showName=true" :value="user.name" />
      <van-cell is-link title="性别" @click="showGender=true" :value="user.gender===0?'男':'女'" />
      <van-cell is-link title="生日" @click="openDate()" :value="user.birthday" />
    </van-cell-group>
    <!-- 资料修改 --> 
    <van-popup v-model="showPhoto" position="bottom">
      <van-cell value="本地相册选择" is-link/>
      <van-cell value="拍照" is-link/>
    </van-popup>
    <van-popup v-model="showName" position="bottom">
      <van-field v-model="user.name" required placeholder="请输入用户名" />
    </van-popup>
    <van-popup v-model="showGender" position="bottom">
      <van-cell value="男" @click="changeGender(0)" is-link/>
      <van-cell value="女" @click="changeGender(1)" is-link/>
    </van-popup>
    <van-popup v-model="showBirthday" position="bottom">
      <van-datetime-picker
        title="选择生日"
        v-model="nowDate"
        type="date"
        :min-date="minDate"
        :max-date="maxDate"
        @cancel="showBirthday=false"
        @confirm="confirmDate"
      />
    </van-popup>
</div>
```

数据：

```js
  data () {
    return {
      // 弹窗控制
      showPhoto: false,
      showName: false,
      showGender: false,
      showBirthday: false,
      // 当前选中日期
      nowDate: new Date(),
      // 最小可选日期
      minDate: new Date('1950-01-01'),
      // 日期控件 最大可选日期
      maxDate: new Date(),
      // 默认用户信息
      photo: 'https://img.yzcdn.cn/vant/cat.jpeg',
      user: {
        name: '默认信息',
        gender: 0,
        birthday: '2019-10-10'
      }
    }
  },
```

函数：

```js
// methods 
// 打开日期选择
openDate () {
  // 有生日数据                                    
  if (this.user.birthday) {
    this.nowDate = new Date(this.user.birthday)
  }
  this.showBirthday = true
},
// 确认选择日期
confirmDate (value) {
  // 确认时间后  把Date转换成String                                    
  this.user.birthday = dayjs(value).format('YYYY-MM-DD')
  this.showBirthday = false
},
changeGender (gender) {
  // 选择性别 gender 0 男  1 女                                    
  this.user.gender = gender
  this.showGender = false
}
```



### 05-个人中心-编辑资料-保存信息

> 获取待编辑信息，编辑和保存

- 获取待编辑信息

1. 封装API `src/api/user.js`=>获取用户个人资料

```js
/**
 * 获取个人中心用户编辑资料信息
 */
export function getUserProfile () {
  return request.get('user/profile')
}
```

2. 渲染：进入编辑页面获取数据渲染

```js
async getUserProfile () {
    const { status, data } = await getUserProfile()
    console.log(data)
    if (status === 200) {
        this.user = data
        this.photo = data.photo
    }
}
```


- 预览头像

1. 使用隐藏域选择图片
2. FileReader对象读取file对象图片数据做展示

```html
<input type="file" @change="preview" ref="fileInput" style="display:none">
```

```html
<van-cell value="本地相册选择" @click="$refs.fileInput.click()" is-link />
```

```js
    // 预览图片
    preview () {
      // 获取当前选择的文件对象
      const file = this.$refs.fileInput.files[0]
      // 从你选择的文件对象读取文件信息=>base64编码格式
      const fileReader = new FileReader()
      fileReader.readAsDataURL(file)
      fileReader.onload = () => {
        // 把读取后的数据 赋值给 src属性即可
        this.photo = fileReader.result
        this.showPhoto = false
      }
    },
```

- 保存用户信息
  - 上传头像
  - 修改信息

`src/api/user.js` 定义接口=》编辑用户照片资料（头像、身份证照片）/ 编辑用户个人资料（包含实名认证）

```js
/**
 * 修改用户头像
 * @param {File} photo - 选中图片后的文件对象
 */
export const updateUserPhoto = (photo) => {
  // 底层基于xhr  发送一个formdata就是上传
  const formdata = new FormData()
  formdata.append('photo', photo)
  return request.patch('user/photo', formdata)
}

/**
 * 修改用户信息
 * @param {String} name - 用户名
 * @param {Integer} gender - 性别 0 男 1 女
 * @param {String} birthday - 生日
 */
export const updateUserInfo = ({ name, gender, birthday }) => {
  return request.patch('user/profile', { name, gender, birthday })
}
```

`src/views/user/profile.vue`

```js
    async save () {
      try {
        /**
         * 1. 上传头像(如果选择了图片执行上传)
         * 2. 修改其它信息
         */
        if (this.$refs.fileInput?.files[0]) {
          await updateUserPhoto(this.$refs.fileInput.files[0])
        }
        await updateUserInfo(this.user)
        this.$toast.success('修改成功')
      } catch (error) {
        console.log(error)
        this.$toast.fail('修改失败')
      }
    }
```

注意⚠️：

1. 判断选择图片后才执行上传，默认图片选择弹层没有加载
2. 性别信息保存失败



### 06-个人中心-小智同学-基础布局和渲染

> 使用模板预览小智同学，了解交互和功能，渲染聊天列表

* 开发模板

结构：

`src/views/user/chat.vue`

```html
  <div class="container">
    <van-nav-bar fixed left-arrow @click-left="$router.back()" title="小智同学"></van-nav-bar>
    <div class="chat-list">
      <div class="chat-item left">
        <van-image fit="cover" round src="https://img.yzcdn.cn/vant/cat.jpeg" />
        <div class="chat-pao">ewqewq</div>
      </div>
      <div class="chat-item right">
        <div class="chat-pao">ewqewq</div>
        <van-image  fit="cover" round src="https://img.yzcdn.cn/vant/cat.jpeg" />
      </div>
    </div>
    <div class="reply-container van-hairline--top">
      <van-field v-model="value" placeholder="说点什么...">
        <span @click="send()" slot="button" style="font-size:12px;color:#999">提交</span>
      </van-field>
    </div>
  </div>
```

样式：

```less
.container {
  height: 100%;
  width: 100%;
  position: absolute;
  left: 0;
  top: 0;
  box-sizing: border-box;
  background:#fafafa;
  padding: 46px 0 50px 0;
  .chat-list {
    height: 100%;
    overflow-y: scroll;
    .chat-item{
      padding: 10px;
      .van-image{
        vertical-align: top;
        width: 40px;
        height: 40px;
      }
      .chat-pao{
        vertical-align: top;
        display: inline-block;
        min-width: 40px;
        max-width: 70%;
        min-height: 40px;
        line-height: 38px;
        border: 0.5px solid #c2d9ea;
        border-radius: 4px;
        position: relative;
        padding: 0 10px;
        background-color: #e0effb;
        word-break: break-all;
        font-size: 14px;
        color: #333;
        &::before{
          content: "";
          width: 10px;
          height: 10px;
          position: absolute;
          top: 12px;
          border-top:0.5px solid #c2d9ea;
          border-right:0.5px solid #c2d9ea;
          background: #e0effb;
        }
      }
    }
  }
}
.chat-item.right{
  text-align: right;
  .chat-pao{
    margin-left: 0;
    margin-right: 15px;
    &::before{
      right: -6px;
      transform: rotate(45deg);
    }
  }
}
.chat-item.left{
  text-align: left;
  .chat-pao{
    margin-left: 15px;
    margin-right: 0;
    &::before{
      left: -5px;
      transform: rotate(-135deg);
    }
  }
}
.reply-container {
  position: fixed;
  left: 0;
  bottom: 0;
  height: 44px;
  width: 100%;
  background: #f5f5f5;
  z-index: 9999;
}
```

数据：

```js
export default {
  data () {
    return {
      value: ''
    }
  },
  methods: {
    send () {

    }
  }
}
```
* 渲染聊天列表
1. 聊天内容列表=》设计数据结构

```js
// 聊天记录列表
// 约定：小智 {name:'xz',msg:''} 自己 {name:'self',msg:''}
list: []
```

2. 渲染聊天内容列表数据=》数据驱动视图

	- 小智的头像  `src/assets/images/xz.png`

```js
// 引入本地图片
/**
 * 1. 通过import 导入 => base64
 * 2. 通过require导入 => 相对路径
 */	
import xzAvatar from '../../assets/images/xz.png'
```

```js
// data() 中
xzAvatar
```

```html
<van-image fit="cover" round :src="xzAvatar" />
```
```html
<!-- 列表渲染 -->  
<div
       class="chat-item"
       :class="{left:item.name==='xz',right:item.name==='self'}"
       v-for="(item,i) in list"
       :key="i"
       >
    <van-image v-if="item.name==='xz'" fit="cover" round :src="xzAvatar" />
    <div class="chat-pao">{{item.msg}}</div>
    <van-image v-if="item.name==='self'" fit="cover" round :src="photo" />
  </div>
```



### 07-个人中心-小智同学-认识websocket

> WebSocket 是一种数据通信协议，类似于我们常见的 http 协议。

* 初次接触 WebSocket 的人，都会问同样的问题：我们已经有了 HTTP 协议，为什么还需要另一个协议？

它能带来什么好处？

​	  答案很简单，因为 HTTP 协议有一个缺陷：**通信只能由客户端发起**。

* 这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。我们只能使用 **"轮询"** 每隔一段时候，就发出一个询问，了解服务器有没有新的信息。最典型的场景就是聊天室。

注意⚠️：

1. 轮询的**效率低**，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。
2. 因此，工程师们一直在思考，有没有更好的方法。WebSocket 就是这样发明的。
3. WebSocket 协议在2008年诞生，2011年成为国际标准。

**结论：它的最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话。**

![img](assets/bg2017051502.01881d8f.png)



### 08-个人中心-小智同学-使用websocket

> 浏览器为 HTTP 通信提供了 XMLHttpRequest 对象，同样的，也为 **WebSocket** 通信提供了一个操作接口：WebSocket。(http https) === (ws wss)

通信模型：

- 拨号（建立连接）
- 通话（双向通信）
- 结束通话（关闭连接）

体验代码：http://websocket.org

```js
// 创建连接（和服务器建立连接，回复你）
var ws = new WebSocket("wss://echo.websocket.org");

// 连接成功
ws.onopen = function(evt) { 
  console.log("Connection open ..."); 
  // 发送消息
  ws.send("Hello WebSockets!");
};

// 接收信息
ws.onmessage = function(evt) {
  // 服务回复消息
  console.log( "Received Message: " + evt.data);
  // 关闭连接
  ws.close();
};

// 连接已经关闭
ws.onclose = function(evt) {
  console.log("Connection closed.");
}; 
```



### 09-个人中心-小智同学-认识socket.io

> 原生的 WebSocket 使用比较麻烦，所以推荐使用一个封装好的解决方案：socket.io 。

说明：socket.io基于WebSocket做了封装，更好用而且更强大（ajax=>axios）

socket.io 提供了服务端 + 客户端的实现

- 客户端：浏览器（前端同学使用）
- 服务端：Java、Python、PHP、。。。。Node.js

官网：https://socket.io/

代码：https://github.com/socketio/socket.io



### 10-个人中心-小智同学-后台服务说明

官网的DEMO：https://socket.io/get-started/chat/

**总结：我们关注的是客户端代码。**

- 发消息：`socket.emit('message', '内容');`=》客户端向服务器发消息
- 收消息：`socket.on('message', function(msg){}`=》接收服务器的消息

注意⚠️：这个`message`后台同学提供的自定义事件名称

### 11-个人中心-小智同学-聊天头像

> 处理聊天对象头像渲染

- **和小智对话的登录人头像**存储到vuex模块中

1. 新建`src/store/chat/index.js`  存储头像vuex模块

```js
export default {
  state: {
    photo: localStorage.getItem('uphoto') || ''
  },
  getters: {
    photo: state => {
      return state.photo
    }
  },
  mutations: {
    setPhoto (state, payload) {
      state.photo = payload
      localStorage.setItem('uphoto', payload)
    }
  }
}
```

2. 在`src/store/index.js`中导入vuex模块

```diff
// 导入模块
+ import chat from './chat'
...
export default new Vuex.Store({
...
+ modules: { chat }
})

```



3. `src/views/profile/index.vue`  个人中心页面，设置头像信息

```diff
+  ...mapMutations(['delToken', 'setPhoto']),
   async getUserInfo () {
      const data = await getUserInfo()
      this.userInfo = data
+      this.setPhoto(data.photo)
    }
```

4. `src/views/user/chat.vue` 使用头像

```js
import { mapGetters } from 'vuex
```

```js
  computed: {
    ...mapGetters(['photo'])
  },
```

```html
<van-image fit="cover" round :src="photo" />
```



### 12-个人中心-小智同学-聊天实现

> 使用socket.io插件开发聊天功能

安装：`npm i socket.io-client`

导入：`import io from 'socket.io-client'` 

使用文档：https://socket.io/docs/client-api/#IO

wsUrl：http://geek.itheima.net

1. 建立连接

语法：`io(url:string, opt:object)`

```js
  created () {
    this.socket = io('http://geek.itheima.net', {
      transports: ['websocket'],
      query: {
        token:  this.user?.token
      }
    })
    this.socket.on('connect', () => {
      // 建了链接后默认  小智给你打招呼
      this.list.push({ name: 'xz', msg: '你好' })
    })
  },
```
注意⚠️：因为**新版本**socket.io默认是socket模式，存在跨域问题。这里使用websocket模式，需要连接时指定！！！

> socket和websocket是不一样的

Socket其实并不是一个协议，而是为了方便使用TCP或UDP而抽象出来的一层，是位于应用层和传输控制层之间的一组接口。Socket是应用层与TCP/IP协议族通信的中间软件抽象层，它是一组接口。WebSocket则是一个典型的应用层协议。**Socket是传输控制层协议，WebSocket是应用层协议**。 

2.  发送消息

语法：`ws.emit('eventName', data)`

```js
    send () {
      this.socket.emit('message', { msg: this.value })
      this.list.push({ name: 'self', msg: this.value })
      this.value = ''
    }
```

3. 接收消息

语法：：`ws.on('eventName', function(data){})`

```diff
    this.socket.on('connect', () => {
      // 建了链接后默认  小智给你打招呼
      this.list.push({ name: 'xz', msg: '你好' })
    })
+    this.socket.on('message', data => {
+      // 接受机器人消息
+      this.list.push({ name: 'xz', msg: data.msg })
+    })
```

4. 滚动底部

```html
<div class="chat-list" ref="list">
```

```js
    scrollBottom () {
      // 在dom异步更新之后执行滚动
      this.$nextTick(() => {
        this.$refs.list.scrollTop = this.$refs.list.scrollHeight
      })
    },
```

```diff
    this.socket.on('message', data => {
      // 接受机器人消息
      this.list.push({ name: 'xz', msg: data.msg })
+      this.scrollBottom()
    })
```

5. 关闭ws连接

```js
beforeDestroy () {
  this.socket.close()
}
```

### 第七天重点总结
